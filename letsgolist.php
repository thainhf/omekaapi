<?php//กำหนดค่า Access-Control-Allow-Origin ให้ เครื่อง อื่น ๆ สามารถเรียกใช้งานหน้านี้ได้include_once("config_header.php");?><?php$requestMethod = $_SERVER["REQUEST_METHOD"];include_once("custom_function.php");//==========================include_once("config_url.php");//==========================//ตรวจสอบหากใช้ Method GET        // popularlist.php?toplimit=10$dataArray = array();$dataArray2 = array();        //ตรวจสอบการส่งค่า id        if(isset($_GET['limit']) && !empty($_GET['limit'])){            $limit = $_GET['limit'];            if(!empty($limit)){                $vlimit=$limit;            }else{                $vlimit=20;            }            if(isset($_GET['cyear']) && !empty($_GET['cyear'])){                $year_count=$_GET['cyear'];            }else{                $year_count=5;            }            $cur_year = date("Y");            //  echo $cur_year."<br>";            function dateRange($first, $last, $step = '+1 year', $format = 'Y-m-d' ) {                $dates = array();                $current = strtotime($first);                $last = strtotime($last);                while( $current <= $last ) {                    $dates[] = date($format, $current);                    $current = strtotime($step, $current);                }                return $dates;            }            $cur_year_back=$cur_year-$year_count+1;            $startTime  = $cur_year_back.'-01-01';            $endTime = $cur_year.'-01-01';            // echo $startTime."-".$endTime."<br>";            $year_arr = dateRange($startTime, $endTime, "+1 year", "Y");            rsort($year_arr); //เรียงจาก มากไปน้อย            //   print_r($year_arr);            //  $begin = new DateTime( "2015-07-03" );            // $end   = new DateTime( "2015-07-09" );            //  $year            //   echo "<br>";            $vomekas_url = $config["omekas_url"];            //  $catesNameArray= array();            if(!empty($year_arr)){                // property[0][property]=7 คือ ค้นหา Dublin Core : date                $vurl="";                $i=0;                $j=0;                foreach ($year_arr as $yyyy) {                    $i=$i+1;                    if($i==1) {                        $vurl = "&property[0][property]=7&property[0][type]=in&property[0][text]=" . $yyyy;                    }else{                        $vurl=$vurl."&property[".$j."][joiner]=or&property[".$j."][property]=7&property[".$j."][type]=in&property[".$j."][text]=".$yyyy;                    }                    $j=$j+1;                }                //คลังดิจิทัลเอกสารผลงานของศาสตราจารย์นายแพทย์ประเวศ วะสี                //&datetime[0][joiner]=and&datetime[0][field]=created&datetime[0][type]=gte&datetime[0][value]=&is_public=1                //&has_media=&has_original=&has_thumbnails=&has_tags=0                //&page=1&per_page=200                // &resource_template_id[]=2 =>Template ชุดเมทาดาทาศาสตราจารย์นายแพทย์ประเวศ วะสี                $resource_template="&resource_template_id[]=2";                $vurl=$vurl."&site_id=1&sort_by=created&sort_order=desc&datetime[0][joiner]=and&datetime[0][field]=created&datetime[0][type]=gte&datetime[0][value]=&is_public=1&has_media=&has_original=&has_thumbnails=&has_tags=0".$resource_template;                $api_url_count = $vomekas_url."infos?property[0][joiner]=and" .$vurl;                //   echo $api_url_count."<br>";//https://omeka.p-set.org/api/infos?property[0][joiner]=and&property[0][property]=7&property[0][type]=in&property[0][text]=2023&property[1][joiner]=or&property[0][property]=7&property[0][type]=in&property[0][text]=2022&property[1][joiner]=or&property[0][property]=7&property[0][type]=in&property[0][text]=2021&property[1][joiner]=or&property[0][property]=7&property[0][type]=in&property[0][text]=2020&property[1][joiner]=or&property[0][property]=7&property[0][type]=in&property[0][text]=2019&site_id=1&sort_by=created&sort_order=desc&datetime[0][joiner]=and&datetime[0][field]=created&datetime[0][type]=gte&datetime[0][value]=&is_public=1&has_media=&has_original=&has_thumbnails=&has_tags=0                //187//https://omeka.p-set.org/api/infos?property[0][joiner]=and&property[0][property]=7&property[0][type]=in&property[0][text]=2023&property[1][joiner]=or&property[1][property]=7&property[1][type]=in&property[1][text]=2022&property[2][joiner]=or&property[2][property]=7&property[2][type]=in&property[2][text]=2021&property[3][joiner]=or&property[3][property]=7&property[3][type]=in&property[3][text]=2020&property[4][joiner]=or&property[4][property]=7&property[4][type]=in&property[4][text]=2019&site_id=1&sort_by=created&sort_order=desc&datetime[0][joiner]=and&datetime[0][field]=created&datetime[0][type]=gte&datetime[0][value]=&is_public=1&has_media=&has_original=&has_thumbnails=&has_tags=0                $json_objcount = cal_curl_api($api_url_count);//            echo "<pre>";//            print_r($json_objcount->items->total);//            echo "</pre>";                $vcount=$json_objcount->items->total;                $api_url = $vomekas_url."items?property[0][joiner]=and" .$vurl."&page=1&per_page=".$vcount;                //  echo $api_url."<br>";                $json_objekat1 = cal_curl_api($api_url);                if(!empty($json_objekat1)){//                 echo "<pre>";//                 print_r($json_objekat1);//                 echo "</pre>";                    $random_numbers = [];                    $random_number2 = 0;                    while(count($random_numbers) < $vlimit){                        do  {                            $random_number = mt_rand(0,$vcount-1);                            $random_number2 = $random_number;                        } while (in_array($random_number2, $random_numbers));                        // $random_numbers[] = $random_number;                        if($random_number2 != 0){                            $random_numbers[] = $random_number2;                        }                    }//                echo "<pre>";//                print_r($random_numbers);//                echo "</pre>";                    foreach ($random_numbers as $item) {                        $title=$json_objekat1[$item]->o_title;                        $o_id=$json_objekat1[$item]->o_id;                        $catesNameArray= array();                        if(isset($json_objekat1[$item]->dcterms_coverage)){                            $dcterms_coverage_arr=$json_objekat1[$item]->dcterms_coverage;                            if(!empty($dcterms_coverage_arr)){                                foreach ($dcterms_coverage_arr as $item_coverage) {                                    array_push($catesNameArray, trim($item_coverage->a_value));                                }                            }                        }                        $data=array(                            "id"=>$o_id,                            "title"=>$title,                            "catenames"=>$catesNameArray,                        );                        array_push($dataArray, $data);                    }                }            }            echo json_encode($dataArray);            //=========end===================================        }else{            $response = ['n.d.'];            echo json_encode($response);        }?>